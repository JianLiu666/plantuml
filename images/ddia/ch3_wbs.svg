<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2321px" preserveAspectRatio="none" style="width:2051px;height:2321px;background:#EFF1F3;" version="1.1" viewBox="0 0 2051 2321" width="2051px" zoomAndPan="magnify"><defs/><g><rect fill="#323232" height="26.1328" rx="7.5" ry="7.5" style="stroke:#323232;stroke-width:0.0;" width="241" x="884.75" y="10"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="229" x="890.75" y="27.6016">DDIA Chapter.3 - Storage and Retrieval</text><line style="stroke:#323232;stroke-width:1.5;" x1="1005.25" x2="1005.25" y1="36.1328" y2="56.1328"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="139" y1="56.1328" y2="76.1328"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="258" x="10" y="76.1328"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="246" x="16" y="93.7344">Data Structures That Power Your Database</text><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="117.332" y2="117.332"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="292" x="149" y="104.2656"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="280" x="155" y="121.8672">透過 Index 結構儲存資料，提升未來查詢時的效率。</text><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="145.4648" y2="145.4648"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="315" x="149" y="132.3984"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="303" x="155" y="150">會增加額外的資料量保存 Index 結構需要的 metadata。</text><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="173.5977" y2="173.5977"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="220" x="149" y="160.5313"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="208" x="155" y="178.1328">維護 Index 會增加寫入資料時的成本。</text><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="201.7305" y2="201.7305"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="90" x="149" y="188.6641"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="78" x="155" y="206.2656">Hash Indexes</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="229.8633" y2="229.8633"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="306" x="204" y="216.7969"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="294" x="210" y="234.3984">透過 dictionary(aka hash map or hash table) 實現。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="257.9961" y2="257.9961"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="382" x="204" y="244.9297"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="370" x="210" y="262.5313">hash map 保存在 memory，raw data 保存在磁碟(append-only)。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="286.1289" y2="286.1289"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="439" x="204" y="273.0625"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="427" x="210" y="290.6641">append-only 能夠安全的處理併發控制請求，與有序寫入磁碟，加快寫入速度。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="314.2617" y2="314.2617"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="336" x="204" y="301.1953"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="324" x="210" y="318.7969">承上，能夠避免系統崩潰時造成不特定資料位置損毀的問題。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="342.3945" y2="342.3945"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="428" x="204" y="329.3281"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="416" x="210" y="346.9297">定時將磁碟內的 raw data 進行分割(segmentataion) 與壓縮(compression)。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="370.5273" y2="370.5273"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="235" x="204" y="357.4609"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="223" x="210" y="375.0625">以二進制格式表示 raw data，優化效能。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="398.6602" y2="398.6602"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="224" x="204" y="385.5938"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="212" x="210" y="403.1953">定時儲存用來災難恢復時的 snapshot。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="204" y1="426.793" y2="426.793"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="416" x="204" y="413.7266"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="404" x="210" y="431.3281">必須確保 memory 有足夠的空間儲存 hash map，以及對範圍查詢不友好。</text><line style="stroke:#323232;stroke-width:1.5;" x1="194" x2="194" y1="214.7969" y2="426.793"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="454.9258" y2="454.9258"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="155" x="149" y="441.8594"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="155" y="459.4609">SSTables and LSM-Trees</text><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="483.0586" y2="483.0586"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="215" x="236.5" y="469.9922"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="203" x="242.5" y="487.5938">Sorted String Table, 簡稱 SSTable。</text><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="511.1914" y2="511.1914"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="367" x="236.5" y="498.125"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="355" x="242.5" y="515.7266">Base on Hash Indexes，會在背景不斷的依序合併壓縮過的資料。</text><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="539.3242" y2="539.3242"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="297" x="236.5" y="526.2578"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="285" x="242.5" y="543.8594">使 hash map 可以用更少的 key 維護相同的資料量。</text><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="574.5234" y2="574.5234"/><rect fill="#EFF1F3" height="40.2656" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="360" x="236.5" y="554.3906"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="348" x="242.5" y="571.9922">由於資料是有序的，可以將範圍內的資料在寫入時再次進行壓減少</text><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="177" x="242.5" y="586.125">寫入時的 I/O 頻寬(bandwitch)。</text><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="609.7227" y2="609.7227"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="228" x="236.5" y="596.6563"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="216" x="242.5" y="614.2578">Constructing and maintaining SSTable</text><line style="stroke:#323232;stroke-width:1.5;" x1="350.5" x2="360.5" y1="637.8555" y2="637.8555"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="242" x="360.5" y="624.7891"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="230" x="366.5" y="642.3906">SSTable 在 memory 的前身: memtable。</text><line style="stroke:#323232;stroke-width:1.5;" x1="350.5" x2="360.5" y1="673.0547" y2="673.0547"/><rect fill="#EFF1F3" height="40.2656" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="285" x="360.5" y="652.9219"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="273" x="366.5" y="670.5234">承上，透過有序結構(e.g. Red-Black Tree) 維護，</text><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="161" x="366.5" y="684.6563">降低整理成 SSTable 的時間。</text><line style="stroke:#323232;stroke-width:1.5;" x1="350.5" x2="360.5" y1="708.2539" y2="708.2539"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="305" x="360.5" y="695.1875"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="293" x="366.5" y="712.7891">查詢順序: memtable, 1st SSTable, 2nd and so on。</text><line style="stroke:#323232;stroke-width:1.5;" x1="350.5" x2="360.5" y1="736.3867" y2="736.3867"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="283" x="360.5" y="723.3203"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="271" x="366.5" y="740.9219">需要維護僅在 memory 的 memtable(e.g. WAL)。</text><line style="stroke:#323232;stroke-width:1.5;" x1="350.5" x2="350.5" y1="622.7891" y2="736.3867"/><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="764.5195" y2="764.5195"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="213" x="236.5" y="751.4531"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="201" x="242.5" y="769.0547">Making an LSM-tree out of SSTable</text><line style="stroke:#323232;stroke-width:1.5;" x1="343" x2="353" y1="792.6523" y2="792.6523"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="270" x="353" y="779.5859"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="258" x="359" y="797.1875">Log Structured Merge Tree，簡稱 LSM-tree。</text><line style="stroke:#323232;stroke-width:1.5;" x1="343" x2="353" y1="820.7852" y2="820.7852"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="187" x="353" y="807.7188"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="175" x="359" y="825.3203">代表產品: LevelDB、RocksDB。</text><line style="stroke:#323232;stroke-width:1.5;" x1="343" x2="343" y1="777.5859" y2="820.7852"/><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="236.5" y1="848.918" y2="848.918"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="166" x="236.5" y="835.8516"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="154" x="242.5" y="853.4531">Performance optimizations</text><line style="stroke:#323232;stroke-width:1.5;" x1="319.5" x2="329.5" y1="877.0508" y2="877.0508"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="356" x="329.5" y="863.9844"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="344" x="335.5" y="881.5859">當無法在 memtable 命中索引時，會產生無法預期的 I/O 開銷。</text><line style="stroke:#323232;stroke-width:1.5;" x1="319.5" x2="329.5" y1="905.1836" y2="905.1836"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="197" x="329.5" y="892.1172"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="185" x="335.5" y="909.7188">透過 Bloom Filter 減少 I/O 開銷。</text><line style="stroke:#323232;stroke-width:1.5;" x1="319.5" x2="329.5" y1="933.3164" y2="933.3164"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="278" x="329.5" y="920.25"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="266" x="335.5" y="937.8516">壓縮與合併的兩大策略: Size-Tiered、Leveling。</text><line style="stroke:#323232;stroke-width:1.5;" x1="319.5" x2="329.5" y1="961.4492" y2="961.4492"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="232" x="329.5" y="948.3828"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="220" x="335.5" y="965.9844">Size-Tiered: 寫入成本低、讀取成本高。</text><line style="stroke:#323232;stroke-width:1.5;" x1="319.5" x2="329.5" y1="989.582" y2="989.582"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="210" x="329.5" y="976.5156"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="198" x="335.5" y="994.1172">Leveling: 寫入成本高、讀取成本低。</text><line style="stroke:#323232;stroke-width:1.5;" x1="319.5" x2="319.5" y1="861.9844" y2="989.582"/><line style="stroke:#323232;stroke-width:1.5;" x1="226.5" x2="226.5" y1="467.9922" y2="848.918"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="1017.7148" y2="1017.7148"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="59" x="149" y="1004.6484"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="47" x="155" y="1022.25">B-Trees</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1045.8477" y2="1045.8477"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="317" x="188.5" y="1032.7813"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="305" x="194.5" y="1050.3828">經典結構，基本上 RDBs 標配，大多 NoSQLs 都有支援。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1073.9805" y2="1073.9805"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="251" x="188.5" y="1060.9141"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="239" x="194.5" y="1078.5156">將資料按固定大小切割成一個單位，pages。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1102.1133" y2="1102.1133"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="220" x="188.5" y="1089.0469"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="208" x="194.5" y="1106.6484">透過 pages 互相關聯成一棵 B-Tree。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1130.2461" y2="1130.2461"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="244" x="188.5" y="1117.1797"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="232" x="194.5" y="1134.7813">value 可能存在 child node 或 leaf node。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1158.3789" y2="1158.3789"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="269" x="188.5" y="1145.3125"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="257" x="194.5" y="1162.9141">寫入操作會因為發生 page split 產生額外開銷。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1186.5117" y2="1186.5117"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="422" x="188.5" y="1173.4453"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="410" x="194.5" y="1191.0469">參考指標: branching factor，表示一個 page 允許參考的 pages 最大上限。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1214.6445" y2="1214.6445"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="271" x="188.5" y="1201.5781"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="259" x="194.5" y="1219.1797">B-Tree 深度通常落在 3~4 層，減少 I/O 開銷。</text><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1242.7773" y2="1242.7773"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="137" x="188.5" y="1229.7109"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125" x="194.5" y="1247.3125">Make B-trees reliable</text><line style="stroke:#323232;stroke-width:1.5;" x1="257" x2="267" y1="1270.9102" y2="1270.9102"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="262" x="267" y="1257.8438"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="250" x="273" y="1275.4453">透過 WAL 確保寫入操作失敗時能夠 rollback。</text><line style="stroke:#323232;stroke-width:1.5;" x1="257" x2="267" y1="1299.043" y2="1299.043"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="183" x="267" y="1285.9766"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="171" x="273" y="1303.5781">輕量鎖: latch 確保資料一致性。</text><line style="stroke:#323232;stroke-width:1.5;" x1="257" x2="257" y1="1255.8438" y2="1299.043"/><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="188.5" y1="1327.1758" y2="1327.1758"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="130" x="188.5" y="1314.1094"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="118" x="194.5" y="1331.7109">B-tree optimizations</text><line style="stroke:#323232;stroke-width:1.5;" x1="253.5" x2="263.5" y1="1355.3086" y2="1355.3086"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="227" x="263.5" y="1342.2422"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="215" x="269.5" y="1359.8438">LMDB 透過 copy-on-write 取代 WAL。</text><line style="stroke:#323232;stroke-width:1.5;" x1="253.5" x2="263.5" y1="1383.4414" y2="1383.4414"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="380" x="263.5" y="1370.375"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="368" x="269.5" y="1387.9766">僅在 leaf node 保存實際資料，提高 branching factor 也縮減層數。</text><line style="stroke:#323232;stroke-width:1.5;" x1="253.5" x2="263.5" y1="1411.5742" y2="1411.5742"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="312" x="263.5" y="1398.5078"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="300" x="269.5" y="1416.1094">leaf node 加入鄰近 pages reference，優化範圍查詢。</text><line style="stroke:#323232;stroke-width:1.5;" x1="253.5" x2="253.5" y1="1340.2422" y2="1411.5742"/><line style="stroke:#323232;stroke-width:1.5;" x1="178.5" x2="178.5" y1="1030.7813" y2="1327.1758"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="1439.707" y2="1439.707"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="218" x="149" y="1426.6406"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="206" x="155" y="1444.2422">Comparing B-Trees and LSM-Trees</text><line style="stroke:#323232;stroke-width:1.5;" x1="258" x2="268" y1="1467.8398" y2="1467.8398"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="295" x="268" y="1454.7734"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="283" x="274" y="1472.375">LSM-Tree 因 append-only，具備超高寫入吞吐量。</text><line style="stroke:#323232;stroke-width:1.5;" x1="258" x2="268" y1="1495.9727" y2="1495.9727"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="309" x="268" y="1482.9063"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="297" x="274" y="1500.5078">B-Tree 其本身結構特性，在讀取時能夠保證 one run。</text><line style="stroke:#323232;stroke-width:1.5;" x1="258" x2="268" y1="1524.1055" y2="1524.1055"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="263" x="268" y="1511.0391"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="251" x="274" y="1528.6406">B-Tree 寫入開銷: WAL、Page、Split Pages。</text><line style="stroke:#323232;stroke-width:1.5;" x1="258" x2="268" y1="1552.2383" y2="1552.2383"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="156" x="268" y="1539.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="144" x="274" y="1556.7734">Advantages of LSM-trees</text><line style="stroke:#323232;stroke-width:1.5;" x1="346" x2="356" y1="1580.3711" y2="1580.3711"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="307" x="356" y="1567.3047"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="295" x="362" y="1584.9063">寫入隱形開銷: 壓縮與合併 SSTables 造成的寫入放大。</text><line style="stroke:#323232;stroke-width:1.5;" x1="346" x2="356" y1="1608.5039" y2="1608.5039"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="299" x="356" y="1595.4375"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="287" x="362" y="1613.0391">有序寫入與 append-only 的特性可以有效利用空間。</text><line style="stroke:#323232;stroke-width:1.5;" x1="346" x2="356" y1="1636.6367" y2="1636.6367"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="320" x="356" y="1623.5703"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="308" x="362" y="1641.1719">透過合併策略盡可能保證 non-overlapping 與 one run。</text><line style="stroke:#323232;stroke-width:1.5;" x1="346" x2="346" y1="1565.3047" y2="1636.6367"/><line style="stroke:#323232;stroke-width:1.5;" x1="258" x2="268" y1="1664.7695" y2="1664.7695"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="151" x="268" y="1651.7031"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="139" x="274" y="1669.3047">Downsides of LSM-trees</text><line style="stroke:#323232;stroke-width:1.5;" x1="343.5" x2="353.5" y1="1692.9023" y2="1692.9023"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="314" x="353.5" y="1679.8359"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="302" x="359.5" y="1697.4375">隨著資料增加，背景處理與實際操作可能產生 I/O 競爭。</text><line style="stroke:#323232;stroke-width:1.5;" x1="343.5" x2="353.5" y1="1721.0352" y2="1721.0352"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="299" x="353.5" y="1707.9688"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="287" x="359.5" y="1725.5703">需要注意整併 SSTables 的速度是否跟著上資料成長。</text><line style="stroke:#323232;stroke-width:1.5;" x1="343.5" x2="353.5" y1="1749.168" y2="1749.168"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="143" x="353.5" y="1736.1016"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="131" x="359.5" y="1753.7031">Transaction 成本較高。</text><line style="stroke:#323232;stroke-width:1.5;" x1="343.5" x2="343.5" y1="1677.8359" y2="1749.168"/><line style="stroke:#323232;stroke-width:1.5;" x1="258" x2="258" y1="1452.7734" y2="1664.7695"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="149" y1="1777.3008" y2="1777.3008"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="158" x="149" y="1764.2344"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="146" x="155" y="1781.8359">Other Indexing Structures</text><line style="stroke:#323232;stroke-width:1.5;" x1="228" x2="238" y1="1805.4336" y2="1805.4336"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="186" x="238" y="1792.3672"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="174" x="244" y="1809.9688">Storing values within the index</text><line style="stroke:#323232;stroke-width:1.5;" x1="331" x2="341" y1="1833.5664" y2="1833.5664"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="120" x="341" y="1820.5"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="108" x="347" y="1838.1016">secondary indexes</text><line style="stroke:#323232;stroke-width:1.5;" x1="331" x2="341" y1="1861.6992" y2="1861.6992"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="236" x="341" y="1848.6328"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="224" x="347" y="1866.2344">value 可以是 refer to Clustered index。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331" x2="341" y1="1889.832" y2="1889.832"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="290" x="341" y="1876.7656"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="278" x="347" y="1894.3672">也可以保存在 heap file 上，例如 covering index。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331" x2="331" y1="1818.5" y2="1889.832"/><line style="stroke:#323232;stroke-width:1.5;" x1="228" x2="238" y1="1917.9648" y2="1917.9648"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="136" x="238" y="1904.8984"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="124" x="244" y="1922.5">Multi-column indexes</text><line style="stroke:#323232;stroke-width:1.5;" x1="306" x2="316" y1="1946.0977" y2="1946.0977"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="165" x="316" y="1933.0313"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="153" x="322" y="1950.6328">例如 concatenated index。</text><line style="stroke:#323232;stroke-width:1.5;" x1="306" x2="316" y1="1974.2305" y2="1974.2305"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="132" x="316" y="1961.1641"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="120" x="322" y="1978.7656">對組合順序相當敏感。</text><line style="stroke:#323232;stroke-width:1.5;" x1="306" x2="316" y1="2002.3633" y2="2002.3633"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="122" x="316" y="1989.2969"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="110" x="322" y="2006.8984">代表結構: R-Tree。</text><line style="stroke:#323232;stroke-width:1.5;" x1="306" x2="306" y1="1931.0313" y2="2002.3633"/><line style="stroke:#323232;stroke-width:1.5;" x1="228" x2="238" y1="2030.4961" y2="2030.4961"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="212" x="238" y="2017.4297"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="200" x="244" y="2035.0313">Full-text search and fuzzy indexes</text><line style="stroke:#323232;stroke-width:1.5;" x1="344" x2="354" y1="2058.6289" y2="2058.6289"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="96" x="354" y="2045.5625"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="360" y="2063.1641">適合模糊查詢。</text><line style="stroke:#323232;stroke-width:1.5;" x1="344" x2="354" y1="2086.7617" y2="2086.7617"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="195" x="354" y="2073.6953"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="183" x="360" y="2091.2969">代表結構: Segment Tree、Trie。</text><line style="stroke:#323232;stroke-width:1.5;" x1="344" x2="354" y1="2114.8945" y2="2114.8945"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="206" x="354" y="2101.8281"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="194" x="360" y="2119.4297">代表產品: Lucene、Elasticsearch。</text><line style="stroke:#323232;stroke-width:1.5;" x1="344" x2="344" y1="2043.5625" y2="2114.8945"/><line style="stroke:#323232;stroke-width:1.5;" x1="228" x2="238" y1="2143.0273" y2="2143.0273"/><rect fill="#D3548A" height="26.1328" rx="7.5" ry="7.5" style="stroke:#D3548A;stroke-width:0.0;" width="187" x="238" y="2129.9609"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="175" x="244" y="2147.5625">Keeping everything in memory</text><line style="stroke:#323232;stroke-width:1.5;" x1="331.5" x2="341.5" y1="2171.1602" y2="2171.1602"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="192" x="341.5" y="2158.0938"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="180" x="347.5" y="2175.6953">適用於資料集較小時與資料快取。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331.5" x2="341.5" y1="2206.3594" y2="2206.3594"/><rect fill="#EFF1F3" height="40.2656" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="320" x="341.5" y="2186.2266"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="308" x="347.5" y="2203.8281">透過 Battery-powered RAM、WAF、snapshot 等機制，</text><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="168" x="347.5" y="2217.9609">將資料寫入磁碟保證災難恢復。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331.5" x2="341.5" y1="2241.5586" y2="2241.5586"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="288" x="341.5" y="2228.4922"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="276" x="347.5" y="2246.0938">效能提升關鍵在於省去資料寫入磁碟時的編碼成本。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331.5" x2="341.5" y1="2269.6914" y2="2269.6914"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="261" x="341.5" y="2256.625"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="249" x="347.5" y="2274.2266">能實現更複雜的資料結構，例如 queue、set。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331.5" x2="341.5" y1="2297.8242" y2="2297.8242"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="212" x="341.5" y="2284.7578"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="200" x="347.5" y="2302.3594">透過 Anti-caching 技術增加可用性。</text><line style="stroke:#323232;stroke-width:1.5;" x1="331.5" x2="331.5" y1="2156.0938" y2="2297.8242"/><line style="stroke:#323232;stroke-width:1.5;" x1="228" x2="228" y1="1790.3672" y2="2143.0273"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="139" y1="102.2656" y2="1777.3008"/><line style="stroke:#323232;stroke-width:1.5;" x1="817" x2="817" y1="56.1328" y2="76.1328"/><rect fill="#F4B031" height="26.1328" rx="7.5" ry="7.5" style="stroke:#F4B031;stroke-width:0.0;" width="223" x="705.5" y="76.1328"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="211" x="711.5" y="93.7344">Transaction Processing or Analytics ?</text><line style="stroke:#323232;stroke-width:1.5;" x1="817" x2="827" y1="117.332" y2="117.332"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="314" x="827" y="104.2656"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="302" x="833" y="121.8672">Online Transaction Processing, OLTP: 典型業務操作。</text><line style="stroke:#323232;stroke-width:1.5;" x1="817" x2="827" y1="145.4648" y2="145.4648"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="293" x="827" y="132.3984"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="281" x="833" y="150">Online Analysis Processing, OLAP: 資料分析操作。</text><line style="stroke:#323232;stroke-width:1.5;" x1="817" x2="827" y1="173.5977" y2="173.5977"/><rect fill="#F4B031" height="26.1328" rx="7.5" ry="7.5" style="stroke:#F4B031;stroke-width:0.0;" width="116" x="827" y="160.5313"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="104" x="833" y="178.1328">Data Warehousing</text><line style="stroke:#323232;stroke-width:1.5;" x1="885" x2="895" y1="201.7305" y2="201.7305"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="254" x="895" y="188.6641"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="242" x="901" y="206.2656">避免與 OLTP 密集的資料系統相互競爭資源。</text><line style="stroke:#323232;stroke-width:1.5;" x1="885" x2="895" y1="229.8633" y2="229.8633"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="192" x="895" y="216.7969"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="180" x="901" y="234.3984">整合大型企業中的所有產品資料。</text><line style="stroke:#323232;stroke-width:1.5;" x1="885" x2="895" y1="257.9961" y2="257.9961"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="162" x="895" y="244.9297"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="150" x="901" y="262.5313">通常是 read-only copies。</text><line style="stroke:#323232;stroke-width:1.5;" x1="885" x2="895" y1="286.1289" y2="286.1289"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="299" x="895" y="273.0625"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="287" x="901" y="290.6641">常見資料搬遷流程: Extract-Transform-Load, ETL。</text><line style="stroke:#323232;stroke-width:1.5;" x1="885" x2="895" y1="314.2617" y2="314.2617"/><rect fill="#F4B031" height="26.1328" rx="7.5" ry="7.5" style="stroke:#F4B031;stroke-width:0.0;" width="374" x="895" y="301.1953"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="362" x="901" y="318.7969">The divergence between OLTP databases and data warehouse</text><line style="stroke:#323232;stroke-width:1.5;" x1="1082" x2="1092" y1="342.3945" y2="342.3945"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="298" x="1092" y="329.3281"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="286" x="1098" y="346.9297">好用的 SQL 分析工具: drill-down、slicing、dicing。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1082" x2="1092" y1="377.5938" y2="377.5938"/><rect fill="#EFF1F3" height="40.2656" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="325" x="1092" y="357.4609"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="313" x="1098" y="375.0625">同時對 OLTP、OLAP 友好的產品: Microsoft SQL Server、</text><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="71" x="1098" y="389.1953">SAP HANA。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1082" x2="1092" y1="412.793" y2="412.793"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="235" x="1092" y="399.7266"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="223" x="1098" y="417.3281">近期誕生的開源產品: SQL-on-Hadoop。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1082" x2="1092" y1="447.9922" y2="447.9922"/><rect fill="#EFF1F3" height="40.2656" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="317" x="1092" y="427.8594"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="305" x="1098" y="445.4609">關鍵字: Google's Dremel、Apache Hive、Spark SQL、</text><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="217" x="1098" y="459.5938">Cloudera Implala、Facebook Presto。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1082" x2="1082" y1="327.3281" y2="447.9922"/><line style="stroke:#323232;stroke-width:1.5;" x1="885" x2="885" y1="186.6641" y2="314.2617"/><line style="stroke:#323232;stroke-width:1.5;" x1="817" x2="827" y1="483.1914" y2="483.1914"/><rect fill="#F4B031" height="26.1328" rx="7.5" ry="7.5" style="stroke:#F4B031;stroke-width:0.0;" width="265" x="827" y="470.125"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="253" x="833" y="487.7266">Stars and Snowflakes: Schemas for Analytics</text><line style="stroke:#323232;stroke-width:1.5;" x1="959.5" x2="969.5" y1="511.3242" y2="511.3242"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="217" x="969.5" y="498.2578"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="205" x="975.5" y="515.8594">Warehouse 常用格式: Star schema。</text><line style="stroke:#323232;stroke-width:1.5;" x1="959.5" x2="969.5" y1="539.457" y2="539.457"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="194" x="969.5" y="526.3906"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182" x="975.5" y="543.9922">最大張的關聯資料表: fact table。</text><line style="stroke:#323232;stroke-width:1.5;" x1="959.5" x2="969.5" y1="567.5898" y2="567.5898"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="310" x="969.5" y="554.5234"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="298" x="975.5" y="572.125">所有的額外資料都透過 foreign key 關聯到 fact table。</text><line style="stroke:#323232;stroke-width:1.5;" x1="959.5" x2="959.5" y1="496.2578" y2="567.5898"/><line style="stroke:#323232;stroke-width:1.5;" x1="817" x2="817" y1="102.2656" y2="483.1914"/><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1516.5" y1="56.1328" y2="76.1328"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="159" x="1437" y="76.1328"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="147" x="1443" y="93.7344">Column-Oriented Storage</text><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1526.5" y1="117.332" y2="117.332"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="391" x="1526.5" y="104.2656"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="379" x="1532.5" y="121.8672">因為 fact table 的特性，不適合採用傳統的 Row-Oriented 方式儲存。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1526.5" y1="145.4648" y2="145.4648"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="344" x="1526.5" y="132.3984"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="332" x="1532.5" y="150">Column-Oriented 優勢在於減少在查詢時所需的資料載入量。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1526.5" y1="173.5977" y2="173.5977"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="134" x="1526.5" y="160.5313"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="122" x="1532.5" y="178.1328">Column Compression</text><line style="stroke:#323232;stroke-width:1.5;" x1="1593.5" x2="1603.5" y1="201.7305" y2="201.7305"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="144" x="1603.5" y="188.6641"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="132" x="1609.5" y="206.2656">使用 Bitmap 壓縮資料。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1593.5" x2="1603.5" y1="229.8633" y2="229.8633"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="277" x="1603.5" y="216.7969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="265" x="1609.5" y="234.3984">Memory bandwitch and vectorized processing</text><line style="stroke:#323232;stroke-width:1.5;" x1="1742" x2="1752" y1="257.9961" y2="257.9961"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="194" x="1752" y="244.9297"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182" x="1758" y="262.5313">效能瓶頸之一: disk to memory。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1742" x2="1752" y1="286.1289" y2="286.1289"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="232" x="1752" y="273.0625"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="220" x="1758" y="290.6641">效能瓶頸之二: memory to CPU Cache。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1742" x2="1752" y1="314.2617" y2="314.2617"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="278" x="1752" y="301.1953"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="266" x="1758" y="318.7969">應用 vectorized processing 技術與 SIMD 技術。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1742" x2="1742" y1="242.9297" y2="314.2617"/><line style="stroke:#323232;stroke-width:1.5;" x1="1593.5" x2="1593.5" y1="186.6641" y2="229.8633"/><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1526.5" y1="342.3945" y2="342.3945"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="180" x="1526.5" y="329.3281"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="168" x="1532.5" y="346.9297">Sort Order in Column Storage</text><line style="stroke:#323232;stroke-width:1.5;" x1="1616.5" x2="1626.5" y1="370.5273" y2="370.5273"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="414" x="1626.5" y="357.4609"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="402" x="1632.5" y="375.0625">指定頻繁出現在查詢規則的 Column 作為 1st sorted key，提升查詢效率。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1616.5" x2="1626.5" y1="398.6602" y2="398.6602"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="156" x="1626.5" y="385.5938"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="144" x="1632.5" y="403.1953">減少 Bitmap 資料量大小。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1616.5" x2="1626.5" y1="426.793" y2="426.793"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="174" x="1626.5" y="413.7266"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="162" x="1632.5" y="431.3281">Several different sort orders</text><line style="stroke:#323232;stroke-width:1.5;" x1="1713.5" x2="1723.5" y1="454.9258" y2="454.9258"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="218" x="1723.5" y="441.8594"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="206" x="1729.5" y="459.4609">對每份 Replica 使用不同的排序方式。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1713.5" x2="1713.5" y1="439.8594" y2="454.9258"/><line style="stroke:#323232;stroke-width:1.5;" x1="1616.5" x2="1616.5" y1="355.4609" y2="426.793"/><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1526.5" y1="483.0586" y2="483.0586"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="217" x="1526.5" y="469.9922"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="205" x="1532.5" y="487.5938">Writing to Column-Oriented Storage</text><line style="stroke:#323232;stroke-width:1.5;" x1="1635" x2="1645" y1="511.1914" y2="511.1914"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="276" x="1645" y="498.125"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="264" x="1651" y="515.7266">使用 LSM-Tree，解決當發生寫入請求時的困難。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1635" x2="1635" y1="496.125" y2="511.1914"/><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1526.5" y1="539.3242" y2="539.3242"/><rect fill="#BD4231" height="26.1328" rx="7.5" ry="7.5" style="stroke:#BD4231;stroke-width:0.0;" width="294" x="1526.5" y="526.2578"/><text fill="#FFFFFF" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="282" x="1532.5" y="543.8594">Aggregation: Data Cubes and Materialized Views</text><line style="stroke:#323232;stroke-width:1.5;" x1="1673.5" x2="1683.5" y1="567.457" y2="567.457"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="218" x="1683.5" y="554.3906"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="206" x="1689.5" y="571.9922">Materialized View: 查詢結果的備份。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1673.5" x2="1683.5" y1="595.5898" y2="595.5898"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="312" x="1683.5" y="582.5234"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="300" x="1689.5" y="600.125">RDBs 的 Virtual View: 便於查詢使用的捷徑(shortcut)。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1673.5" x2="1683.5" y1="623.7227" y2="623.7227"/><rect fill="#EFF1F3" height="26.1328" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.0;" width="279" x="1683.5" y="610.6563"/><text fill="#333333" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="267" x="1689.5" y="628.2578">每個 Data Cubes 只能對特定查詢進行個別優化。</text><line style="stroke:#323232;stroke-width:1.5;" x1="1673.5" x2="1673.5" y1="552.3906" y2="623.7227"/><line style="stroke:#323232;stroke-width:1.5;" x1="1516.5" x2="1516.5" y1="102.2656" y2="539.3242"/><line style="stroke:#323232;stroke-width:1.5;" x1="139" x2="1516.5" y1="56.1328" y2="56.1328"/><!--MD5=[d893c69621c4513148a53fa0223c81b5]
@startwbs ch3_wbs

skinparam Shadowing false
skinparam BackgroundColor #EFF1F3
skinparam linetype ortho

<style>
arrow {
    LineColor #323232
}
node {
    Padding 6
    Margin 2
    RoundCorner 15
    LineThickness 0.0
    BackgroundColor #EFF1F3
    FontColor #333333
}
.Type_Root {
    BackgroundColor #323232
    FontColor #FFFFFF
    LineColor #323232
}
.Type1_Node {
    BackgroundColor #D3548A
    FontColor #FFFFFF
    LineColor #D3548A
}
.Type1_LeafNode {
    RoundCorner 0
    LineThickness 1.0
    LineColor #D3548A
}
.Type2_Node {
    BackgroundColor #F4B031
    FontColor #FFFFFF
    LineColor #F4B031
}
.Type2_LeafNode {
    RoundCorner 0
    LineThickness 1.0
    LineColor #F4B031
}
.Type3_Node {
    BackgroundColor #BD4231
    FontColor #FFFFFF
    LineColor #BD4231
}
.Type3_LeafNode {
    RoundCorner 0
    LineThickness 1.0
    LineColor #BD4231
}
.Type4_Node {
    BackgroundColor #0F5E8C
    FontColor #FFFFFF
    LineColor #0F5E8C
}
.Type4_LeafNode {
    RoundCorner 0
    LineThickness 1.0
    LineColor #0F5E8C
}
.Type5_Node {
    BackgroundColor #37A7A8
    FontColor #FFFFFF
    LineColor #37A7A8
}
.Type5_LeafNode {
    RoundCorner 0
    LineThickness 1.0
    LineColor #37A7A8
}
</style>

* DDIA Chapter.3 - Storage and Retrieval<<Type_Root>>

** Data Structures That Power Your Database<<Type1_Node>>
*** 透過 Index 結構儲存資料，提升未來查詢時的效率。
*** 會增加額外的資料量保存 Index 結構需要的 metadata。
*** 維護 Index 會增加寫入資料時的成本。

*** Hash Indexes<<Type1_Node>>
**** 透過 dictionary(aka hash map or hash table) 實現。
**** hash map 保存在 memory，raw data 保存在磁碟(append-only)。
**** append-only 能夠安全的處理併發控制請求，與有序寫入磁碟，加快寫入速度。
**** 承上，能夠避免系統崩潰時造成不特定資料位置損毀的問題。
**** 定時將磁碟內的 raw data 進行分割(segmentataion) 與壓縮(compression)。
**** 以二進制格式表示 raw data，優化效能。
**** 定時儲存用來災難恢復時的 snapshot。
**** 必須確保 memory 有足夠的空間儲存 hash map，以及對範圍查詢不友好。

*** SSTables and LSM-Trees<<Type1_Node>>
**** Sorted String Table, 簡稱 SSTable。
**** Base on Hash Indexes，會在背景不斷的依序合併壓縮過的資料。
**** 使 hash map 可以用更少的 key 維護相同的資料量。
**** 由於資料是有序的，可以將範圍內的資料在寫入時再次進行壓減少\n寫入時的 I/O 頻寬(bandwitch)。

**** Constructing and maintaining SSTable<<Type1_Node>>
***** SSTable 在 memory 的前身: memtable。
***** 承上，透過有序結構(e.g. Red-Black Tree) 維護，\n降低整理成 SSTable 的時間。
***** 查詢順序: memtable, 1st SSTable, 2nd and so on。
***** 需要維護僅在 memory 的 memtable(e.g. WAL)。

**** Making an LSM-tree out of SSTable<<Type1_Node>>
***** Log Structured Merge Tree，簡稱 LSM-tree。
***** 代表產品: LevelDB、RocksDB。

**** Performance optimizations<<Type1_Node>>
***** 當無法在 memtable 命中索引時，會產生無法預期的 I/O 開銷。
***** 透過 Bloom Filter 減少 I/O 開銷。
***** 壓縮與合併的兩大策略: Size-Tiered、Leveling。
***** Size-Tiered: 寫入成本低、讀取成本高。
***** Leveling: 寫入成本高、讀取成本低。

*** B-Trees<<Type1_Node>>
**** 經典結構，基本上 RDBs 標配，大多 NoSQLs 都有支援。
**** 將資料按固定大小切割成一個單位，pages。
**** 透過 pages 互相關聯成一棵 B-Tree。
**** value 可能存在 child node 或 leaf node。
**** 寫入操作會因為發生 page split 產生額外開銷。
**** 參考指標: branching factor，表示一個 page 允許參考的 pages 最大上限。
**** B-Tree 深度通常落在 3~4 層，減少 I/O 開銷。


**** Make B-trees reliable<<Type1_Node>>
***** 透過 WAL 確保寫入操作失敗時能夠 rollback。
***** 輕量鎖: latch 確保資料一致性。

**** B-tree optimizations<<Type1_Node>>
***** LMDB 透過 copy-on-write 取代 WAL。
***** 僅在 leaf node 保存實際資料，提高 branching factor 也縮減層數。
***** leaf node 加入鄰近 pages reference，優化範圍查詢。

*** Comparing B-Trees and LSM-Trees<<Type1_Node>>
**** LSM-Tree 因 append-only，具備超高寫入吞吐量。
**** B-Tree 其本身結構特性，在讀取時能夠保證 one run。
**** B-Tree 寫入開銷: WAL、Page、Split Pages。

**** Advantages of LSM-trees<<Type1_Node>>
***** 寫入隱形開銷: 壓縮與合併 SSTables 造成的寫入放大。
***** 有序寫入與 append-only 的特性可以有效利用空間。
***** 透過合併策略盡可能保證 non-overlapping 與 one run。

**** Downsides of LSM-trees<<Type1_Node>>
***** 隨著資料增加，背景處理與實際操作可能產生 I/O 競爭。
***** 需要注意整併 SSTables 的速度是否跟著上資料成長。
***** Transaction 成本較高。

*** Other Indexing Structures<<Type1_Node>>

**** Storing values within the index<<Type1_Node>>
***** secondary indexes
***** value 可以是 refer to Clustered index。
***** 也可以保存在 heap file 上，例如 covering index。

**** Multi-column indexes<<Type1_Node>>
***** 例如 concatenated index。
***** 對組合順序相當敏感。
***** 代表結構: R-Tree。

**** Full-text search and fuzzy indexes<<Type1_Node>>
***** 適合模糊查詢。
***** 代表結構: Segment Tree、Trie。
***** 代表產品: Lucene、Elasticsearch。

**** Keeping everything in memory<<Type1_Node>>
***** 適用於資料集較小時與資料快取。
***** 透過 Battery-powered RAM、WAF、snapshot 等機制，\n將資料寫入磁碟保證災難恢復。
***** 效能提升關鍵在於省去資料寫入磁碟時的編碼成本。
***** 能實現更複雜的資料結構，例如 queue、set。
***** 透過 Anti-caching 技術增加可用性。

** Transaction Processing or Analytics ?<<Type2_Node>>
*** Online Transaction Processing, OLTP: 典型業務操作。
*** Online Analysis Processing, OLAP: 資料分析操作。

*** Data Warehousing<<Type2_Node>>
**** 避免與 OLTP 密集的資料系統相互競爭資源。
**** 整合大型企業中的所有產品資料。
**** 通常是 read-only copies。
**** 常見資料搬遷流程: Extract-Transform-Load, ETL。

**** The divergence between OLTP databases and data warehouse<<Type2_Node>>
***** 好用的 SQL 分析工具: drill-down、slicing、dicing。
***** 同時對 OLTP、OLAP 友好的產品: Microsoft SQL Server、\nSAP HANA。
***** 近期誕生的開源產品: SQL-on-Hadoop。
***** 關鍵字: Google's Dremel、Apache Hive、Spark SQL、\nCloudera Implala、Facebook Presto。

*** Stars and Snowflakes: Schemas for Analytics<<Type2_Node>>
**** Warehouse 常用格式: Star schema。
**** 最大張的關聯資料表: fact table。
**** 所有的額外資料都透過 foreign key 關聯到 fact table。

** Column-Oriented Storage<<Type3_Node>>
*** 因為 fact table 的特性，不適合採用傳統的 Row-Oriented 方式儲存。
*** Column-Oriented 優勢在於減少在查詢時所需的資料載入量。

*** Column Compression<<Type3_Node>>
**** 使用 Bitmap 壓縮資料。

**** Memory bandwitch and vectorized processing<<Type3_Node>>
***** 效能瓶頸之一: disk to memory。
***** 效能瓶頸之二: memory to CPU Cache。
***** 應用 vectorized processing 技術與 SIMD 技術。

*** Sort Order in Column Storage<<Type3_Node>>
**** 指定頻繁出現在查詢規則的 Column 作為 1st sorted key，提升查詢效率。
**** 減少 Bitmap 資料量大小。

**** Several different sort orders<<Type3_Node>>
***** 對每份 Replica 使用不同的排序方式。

*** Writing to Column-Oriented Storage<<Type3_Node>>
**** 使用 LSM-Tree，解決當發生寫入請求時的困難。

*** Aggregation: Data Cubes and Materialized Views<<Type3_Node>>
**** Materialized View: 查詢結果的備份。
**** RDBs 的 Virtual View: 便於查詢使用的捷徑(shortcut)。
**** 每個 Data Cubes 只能對特定查詢進行個別優化。

@endwbs

PlantUML version 1.2021.7(Sun May 23 20:40:07 CST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: TW
--></g></svg>